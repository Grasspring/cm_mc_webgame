<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­é†«å­¸ç¿’é¸æ“‡é¡ŒéŠæˆ²</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .setup-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 14px;
            min-width: 0; /* å…è¨±ç¸®å° */
            line-height: 1.2;
        }

        .checkbox-item:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 6px;
            margin-top: 0;
            margin-bottom: 0;
            transform: scale(1.1);
            vertical-align: middle;
            flex-shrink: 0;
        }

        .checkbox-item label {
            margin: 0;
            line-height: 1.2;
            vertical-align: middle;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .checkbox-item input[type="checkbox"]:checked + label {
            color: #667eea;
            font-weight: bold;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .difficulty-description {
            margin-top: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .difficulty-description small {
            color: #6c757d;
            font-size: 13px;
            line-height: 1.4;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* é–‹å§‹æ¸¬é©—æŒ‰éˆ•ç‰¹æ®Šæ¨£å¼ */
        .start-quiz-button {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 30px auto 20px auto;
            padding: 20px 40px;
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: none;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .start-quiz-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #218838 0%, #1ea080 100%);
        }

        .start-quiz-button:active {
            transform: translateY(-1px);
        }

        /* å…¶ä»–æŒ‰éˆ•å€åŸŸ */
        .other-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .quiz-section {
            display: none;
        }

        .question-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .question-number {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.4em;
            line-height: 1.8;
            white-space: pre-line;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .answer-options {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .answer-option {
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            white-space: pre-line;
            line-height: 1.8;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .answer-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .answer-option.selected {
            border-color: #667eea;
            background: #e6f0ff;
        }

        .answer-option.correct {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .answer-option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .question-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-display {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            white-space: pre-line;
            line-height: 1.6;
        }

        .result-correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .final-score {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            margin-top: 20px;
        }

        .final-score h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .final-score .score {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
        }

        .statistics-report {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .statistics-report h3 {
            color: white;
            margin-bottom: 15px;
            text-align: center;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
        }

        .stat-label {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
        }

        .stats-details {
            display: none;
            margin-top: 20px;
        }

        .stats-details.show {
            display: block;
        }

        .question-result {
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .question-result.correct {
            border-left-color: #28a745;
        }

        .question-result.incorrect {
            border-left-color: #dc3545;
        }

        .question-result-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: white;
        }

        .question-result-content {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
        }

        .user-answer, .correct-answer {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .user-answer.correct {
            background: rgba(40, 167, 69, 0.2);
        }

        .user-answer.incorrect {
            background: rgba(220, 53, 69, 0.2);
        }

        .correct-answer {
            background: rgba(40, 167, 69, 0.2);
        }

        .final-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .stats-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .history-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .history-stats-table th,
        .history-stats-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .history-stats-table th {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        .history-stats-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .accuracy-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            position: relative;
            min-width: 100px;
        }

        .accuracy-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
            transition: width 0.3s ease;
        }

        .accuracy-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .no-stats-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            padding: 40px;
            font-size: 1.1em;
        }

        .hidden {
            display: none !important;
        }

        .show-history {
            display: block !important;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .main-content {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .checkbox-group {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .checkbox-item {
                padding: 6px 8px;
                font-size: 13px;
            }

            .button-group {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .start-quiz-button {
                padding: 16px 30px;
                font-size: 18px;
                margin: 25px auto 15px auto;
            }
            
            .other-buttons {
                gap: 10px;
            }
            
            .other-buttons .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ä¸­é†«å­¸ç¿’é¸æ“‡é¡ŒéŠæˆ²</h1>
            <p>æ¸¬è©¦æ‚¨çš„ä¸­é†«ç†è«–çŸ¥è­˜</p>
        </div>

        <div class="main-content">
            <!-- éŠæˆ²è¨­å®šå€åŸŸ -->
            <div id="setupSection" class="setup-section">
                <div class="section-title">ğŸ“š ç§‘ç›®é¸æ“‡</div>
                <div class="form-group">
                    <label for="subjectSelect">é¸æ“‡å­¸ç¿’ç§‘ç›®ï¼š</label>
                    <select id="subjectSelect">
                        <option value="">è«‹é¸æ“‡ç§‘ç›®...</option>
                    </select>
                </div>

                <div class="section-title">â“ é¡Œå‹è¨­å®š</div>
                <div class="form-group">
                    <label>å•é¡Œå°‡æä¾›ä»€éº¼è³‡è¨Šï¼š</label>
                    <div class="checkbox-group" id="questionInfo">
                        <div class="checkbox-item">
                            <input type="checkbox" id="info-ç—…å" value="ç—…å" checked>
                            <label for="info-ç—…å">ç—…å</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="info-è­‰å‹" value="è­‰å‹" checked>
                            <label for="info-è­‰å‹">è­‰å‹</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="info-æ²»æ³•" value="æ²»æ³•">
                            <label for="info-æ²»æ³•">æ²»æ³•</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="info-æ–¹è—¥" value="æ–¹è—¥">
                            <label for="info-æ–¹è—¥">æ–¹è—¥</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="info-è­‰å€™" value="è­‰å€™">
                            <label for="info-è­‰å€™">è­‰å€™</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ç­”æ¡ˆçµ„åˆçš„è³‡æ–™ï¼š</label>
                    <div class="checkbox-group" id="answerInfo">
                        <div class="checkbox-item">
                            <input type="checkbox" id="ans-ç—…å" value="ç—…å">
                            <label for="ans-ç—…å">ç—…å</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ans-è­‰å‹" value="è­‰å‹">
                            <label for="ans-è­‰å‹">è­‰å‹</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ans-æ²»æ³•" value="æ²»æ³•" checked>
                            <label for="ans-æ²»æ³•">æ²»æ³•</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ans-æ–¹è—¥" value="æ–¹è—¥" checked>
                            <label for="ans-æ–¹è—¥">æ–¹è—¥</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ans-è­‰å€™" value="è­‰å€™">
                            <label for="ans-è­‰å€™">è­‰å€™</label>
                        </div>
                    </div>
                </div>

                <div class="section-title">âš™ï¸ éŠæˆ²è¨­å®š</div>
                <div class="form-group">
                    <label for="optionCount">ç­”æ¡ˆé¸é …æ•¸é‡ï¼š</label>
                    <select id="optionCount">
                        <option value="2">2é …</option>
                        <option value="3">3é …</option>
                        <option value="4" selected>4é …</option>
                        <option value="5">5é …</option>
                        <option value="6">6é …</option>
                        <option value="7">7é …</option>
                        <option value="8">8é …</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="questionCount">å•é¡Œæ•¸é‡ï¼š</label>
                    <select id="questionCount">
                        <option value="10" selected>10é¡Œ</option>
                        <option value="20">20é¡Œ</option>
                        <option value="30">30é¡Œ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="difficultyMode">é›£åº¦è¨­å®šï¼š</label>
                    <select id="difficultyMode">
                        <option value="normal">ä¸€èˆ¬æ¨¡å¼ï¼ˆéš¨æ©Ÿç­”æ¡ˆï¼‰</option>
                        <option value="hard">å›°é›£æ¨¡å¼ï¼ˆåŒç—…åç­”æ¡ˆï¼‰</option>
                    </select>
                    <div class="difficulty-description">
                        <small>
                            <span id="difficultyDesc">ä¸€èˆ¬æ¨¡å¼ï¼šéŒ¯èª¤ç­”æ¡ˆå¾æ‰€æœ‰è³‡æ–™ä¸­éš¨æ©Ÿé¸å–</span>
                        </small>
                    </div>
                </div>

                <!-- é–‹å§‹æ¸¬é©—æŒ‰éˆ• -->
                <button class="start-quiz-button" onclick="startQuiz()">
                    ğŸ¯ é–‹å§‹æ¸¬é©—
                </button>

                <!-- å…¶ä»–åŠŸèƒ½æŒ‰éˆ• -->
                <div class="other-buttons">
                    <button class="btn btn-secondary" onclick="loadDatasetFiles()">ğŸ”„ é‡æ–°æƒææª”æ¡ˆ</button>
                    <button class="btn btn-secondary" onclick="testDataLoad()">ğŸ§ª æ¸¬è©¦æ•¸æ“šè¼‰å…¥</button>
                    <button class="btn btn-secondary" onclick="testEncodingFix()">ğŸ”§ æ¸¬è©¦ç·¨ç¢¼ä¿®å¾©</button>
                    <button class="btn btn-secondary" onclick="showHistoryStats()">ğŸ“ˆ å­¸ç¿’æ­·å²</button>
                </div>
            </div>

            <!-- æ¸¬é©—å€åŸŸ -->
            <div id="quizSection" class="quiz-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="question-header">
                    <div class="question-number" id="questionNumber"></div>
                    <div class="question-text" id="questionText"></div>
                </div>

                <div id="resultDisplay" class="result-display hidden"></div>

                <div class="answer-options" id="answerOptions"></div>

                <div class="question-controls">
                    <button class="btn btn-secondary" onclick="endQuiz()">çµæŸæ¸¬é©—</button>
                    <button class="btn btn-primary" onclick="nextQuestion()" id="nextQuestionBtn" style="display: none;">ä¸‹ä¸€é¡Œ</button>
                    <button class="btn btn-secondary" onclick="showAnswer()" id="showAnswerBtn">ç›´æ¥æŸ¥çœ‹ç­”æ¡ˆ</button>
                </div>
            </div>

            <!-- æœ€çµ‚åˆ†æ•¸å€åŸŸ -->
            <div id="finalScoreSection" class="hidden">
                <div class="final-score">
                    <h2>ğŸ‰ æ¸¬é©—å®Œæˆï¼</h2>
                    <div class="score" id="finalScore"></div>
                    <p id="scoreMessage"></p>
                    
                    <!-- çµ±è¨ˆå ±å‘Š -->
                    <div class="statistics-report">
                        <h3>ğŸ“Š è©³ç´°çµ±è¨ˆå ±å‘Š</h3>
                        <div class="stats-summary" id="statsSummary"></div>
                        <div class="stats-details" id="statsDetails"></div>
                    </div>
                    
                    <div class="final-buttons">
                        <button class="btn btn-secondary" onclick="toggleStatsDetails()" id="toggleStatsBtn">é¡¯ç¤ºè©³ç´°å ±å‘Š</button>
                        <button class="btn btn-primary" onclick="restartGame()">å†ç©ä¸€æ¬¡</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­·å²çµ±è¨ˆå€åŸŸ -->
        <div id="historyStatsSection" class="hidden">
            <div class="final-score">
                <h2>ğŸ“ˆ å­¸ç¿’æ­·å²çµ±è¨ˆ</h2>
                <div class="statistics-report">
                    <div class="stats-controls">
                        <button class="btn btn-secondary" onclick="clearHistoryStats()">æ¸…é™¤æ­·å²è¨˜éŒ„</button>
                        <button class="btn btn-secondary" onclick="exportHistoryStats()">åŒ¯å‡ºçµ±è¨ˆ</button>
                        <button class="btn btn-primary" onclick="hideHistoryStats()">è¿”å›éŠæˆ²</button>
                    </div>
                    <div id="historyStatsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="encrypted_datasets.js"></script>
    <script>
        let currentDataset = [];
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let totalQuestions = 0;
        let questionAnswered = false;
        let currentDifficultyMode = 'normal';
        let questionResults = []; // å­˜å„²æ¯é¡Œçš„ç­”é¡Œçµæœ

        // æ›´æ–°checkboxé …ç›®çš„è¦–è¦ºç‹€æ…‹ï¼ˆå·²ç§»é™¤è‘—è‰²æ•ˆæœï¼‰
        function updateCheckboxItemStyle(item, isChecked) {
            // ä¸å†éœ€è¦è¦–è¦ºç‹€æ…‹æ›´æ–°ï¼Œä¿ç•™å‡½æ•¸ä»¥å…ç ´å£ç¾æœ‰ä»£ç¢¼
        }

        // Cookieæ“ä½œå‡½æ•¸
        // ===== æœ¬åœ°å­˜å„²ç®¡ç†å‡½æ•¸ =====
        
        // è¨­ç½®æœ¬åœ°å­˜å„²æ•¸æ“š
        function setLocalStorage(key, value) {
            try {
                const jsonString = JSON.stringify(value);
                console.log(`ğŸ“ è¨­ç½®LocalStorage: ${key}`);
                console.log(`- é …ç›®æ•¸é‡: ${typeof value === 'object' ? Object.keys(value).length : 'N/A'}`);
                console.log(`- æ•¸æ“šå¤§å°: ${jsonString.length} å­—ç¬¦`);
                
                localStorage.setItem(key, jsonString);
                console.log(`âœ… LocalStorageå·²è¨­ç½®: ${key}`);
                
                // ç«‹å³é©—è­‰
                const verify = getLocalStorage(key);
                if (verify) {
                    const verifyCount = typeof verify === 'object' ? Object.keys(verify).length : 'N/A';
                    console.log(`ğŸ” LocalStorageè¨­ç½®é©—è­‰æˆåŠŸ: ${key}, é …ç›®æ•¸: ${verifyCount}`);
                } else {
                    console.error(`âŒ LocalStorageè¨­ç½®é©—è­‰å¤±æ•—: ${key}`);
                }
                
                return true;
            } catch (error) {
                console.error(`âŒ è¨­ç½®LocalStorageå¤±æ•—: ${key}`, error);
                
                // å¦‚æœæ˜¯å­˜å„²ç©ºé–“ä¸è¶³ï¼Œå˜—è©¦æ¸…ç†
                if (error.name === 'QuotaExceededError') {
                    console.warn('âš ï¸ LocalStorageç©ºé–“ä¸è¶³ï¼Œå˜—è©¦æ¸…ç†èˆŠæ•¸æ“š');
                    if (key === 'cmGameStudyStats' && typeof value === 'object') {
                        return cleanAndSaveStats(value);
                    }
                }
                return false;
            }
        }
        
        // ç²å–æœ¬åœ°å­˜å„²æ•¸æ“š
        function getLocalStorage(key) {
            try {
                const item = localStorage.getItem(key);
                if (item === null) {
                    console.log(`ğŸ“­ LocalStorageä¸­æ²’æœ‰æ‰¾åˆ°: ${key}`);
                    return null;
                }
                
                const parsed = JSON.parse(item);
                console.log(`ğŸ“¬ æˆåŠŸè®€å–LocalStorage: ${key}`, typeof parsed === 'object' ? `é …ç›®æ•¸: ${Object.keys(parsed).length}` : parsed);
                return parsed;
            } catch (error) {
                console.error(`âŒ è®€å–LocalStorageå¤±æ•—: ${key}`, error);
                return null;
            }
        }
        
        // åˆªé™¤æœ¬åœ°å­˜å„²æ•¸æ“š
        function removeLocalStorage(key) {
            try {
                localStorage.removeItem(key);
                console.log(`ğŸ—‘ï¸ å·²åˆªé™¤LocalStorage: ${key}`);
            } catch (error) {
                console.error(`âŒ åˆªé™¤LocalStorageå¤±æ•—: ${key}`, error);
            }
        }
        
        // æ¸…ç†ä¸¦ä¿å­˜çµ±è¨ˆæ•¸æ“š
        function cleanAndSaveStats(stats) {
            try {
                const entries = Object.entries(stats);
                console.log(`ç•¶å‰çµ±è¨ˆé …ç›®æ•¸: ${entries.length}`);
                
                // ä¿ç•™æœ€è¿‘çš„50å€‹é …ç›®
                const keepCount = 50;
                console.log(`æ¸…ç†çµ±è¨ˆæ•¸æ“šï¼Œä¿ç•™æœ€è¿‘çš„ ${keepCount} å€‹é …ç›®`);
                
                // æŒ‰æœ€å¾Œç·´ç¿’æ™‚é–“æ’åº
                const sortedEntries = entries.sort((a, b) => {
                    const timeA = new Date(a[1].lastAttempt || 0);
                    const timeB = new Date(b[1].lastAttempt || 0);
                    return timeB - timeA;
                });
                
                const trimmedStats = {};
                sortedEntries.slice(0, keepCount).forEach(([key, stat]) => {
                    trimmedStats[key] = stat;
                });
                
                const cleanedString = JSON.stringify(trimmedStats);
                localStorage.setItem('cmGameStudyStats', cleanedString);
                
                console.log(`âœ… å·²æ¸…ç†ä¸¦ä¿å­˜çµ±è¨ˆæ•¸æ“š: ${Object.keys(trimmedStats).length} å€‹é …ç›®`);
                return true;
            } catch (error) {
                console.error(`âŒ æ¸…ç†çµ±è¨ˆæ•¸æ“šå¤±æ•—:`, error);
                return false;
            }
        }

        // ç²å–å­¸ç¿’çµ±è¨ˆæ•¸æ“š
        function getStudyStats() {
            return getLocalStorage('cmGameStudyStats') || {};
        }

        // ä¿å­˜å­¸ç¿’çµ±è¨ˆæ•¸æ“š
        function saveStudyStats(stats) {
            return setLocalStorage('cmGameStudyStats', stats);
        }

        // æ›´æ–°ç‰¹å®šç—…å+è­‰å‹çš„çµ±è¨ˆ
        function updateStudyStats(diseaseName, syndromeType, isCorrect) {
            console.log(`\n=== æ›´æ–°å­¸ç¿’çµ±è¨ˆ ===`);
            console.log(`ç—…å: ${diseaseName}, è­‰å‹: ${syndromeType}, æ­£ç¢º: ${isCorrect}`);
            
            if (!diseaseName || !syndromeType) {
                console.error('âŒ çµ±è¨ˆæ›´æ–°å¤±æ•—ï¼šç—…åæˆ–è­‰å‹ç‚ºç©º');
                return;
            }
            
            // è®€å–ç•¶å‰çµ±è¨ˆæ•¸æ“š
            const stats = getStudyStats();
            const beforeCount = Object.keys(stats).length;
            console.log(`ğŸ“Š æ›´æ–°å‰çµ±è¨ˆé …ç›®æ•¸é‡: ${beforeCount}`);
            
            const key = `${diseaseName}_${syndromeType}`;
            console.log(`ğŸ”‘ çµ±è¨ˆéµå€¼: ${key}`);
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°é …ç›®
            const isNewEntry = !stats[key];
            console.log(`ğŸ“ æ˜¯å¦ç‚ºæ–°é …ç›®: ${isNewEntry ? 'æ˜¯' : 'å¦'}`);
            
            if (isNewEntry) {
                stats[key] = {
                    diseaseName: diseaseName,
                    syndromeType: syndromeType,
                    totalAttempts: 0,
                    correctAttempts: 0,
                    lastAttempt: null,
                    firstAttempt: new Date().toISOString()
                };
                console.log(`âœ¨ å‰µå»ºæ–°çš„çµ±è¨ˆé …ç›®: ${key}`);
            } else {
                console.log(`ğŸ”„ æ›´æ–°ç¾æœ‰çµ±è¨ˆé …ç›®: ${key}`);
            }
            
            // è¨˜éŒ„æ›´æ–°å‰çš„ç‹€æ…‹
            const beforeUpdate = { ...stats[key] };
            
            // æ›´æ–°çµ±è¨ˆæ•¸æ“š
            stats[key].totalAttempts++;
            if (isCorrect) {
                stats[key].correctAttempts++;
            }
            stats[key].lastAttempt = new Date().toISOString();
            
            console.log(`ğŸ“ˆ çµ±è¨ˆæ›´æ–°:`);
            console.log(`   ç¸½æ¬¡æ•¸: ${beforeUpdate.totalAttempts} â†’ ${stats[key].totalAttempts}`);
            console.log(`   æ­£ç¢ºæ¬¡æ•¸: ${beforeUpdate.correctAttempts} â†’ ${stats[key].correctAttempts}`);
            
            const afterCount = Object.keys(stats).length;
            console.log(`ğŸ“Š æ›´æ–°å¾Œçµ±è¨ˆé …ç›®æ•¸é‡: ${beforeCount} â†’ ${afterCount}`);
            
            try {
                // æª¢æŸ¥æ•¸æ“šå¤§å°
                const statsString = JSON.stringify(stats);
                console.log(`ğŸ’¾ çµ±è¨ˆæ•¸æ“šJSONå¤§å°: ${statsString.length} å­—ç¬¦`);
                
                // ä¿å­˜çµ±è¨ˆæ•¸æ“š
                saveStudyStats(stats);
                console.log(`âœ… çµ±è¨ˆæ•¸æ“šå·²ä¿å­˜`);
                
                // ç«‹å³é©—è­‰ä¿å­˜çµæœ
                setTimeout(() => {
                    const savedStats = getStudyStats();
                    const savedCount = Object.keys(savedStats).length;
                    const savedItem = savedStats[key];
                    
                    console.log(`ï¿½ ä¿å­˜é©—è­‰çµæœ:`);
                    console.log(`   æœŸæœ›é …ç›®æ•¸: ${afterCount}, å¯¦éš›é …ç›®æ•¸: ${savedCount}`);
                    console.log(`   æœŸæœ›é …ç›®å­˜åœ¨: ${key}`);
                    console.log(`   å¯¦éš›é …ç›®å…§å®¹:`, savedItem);
                    
                    // æ›´ç²¾ç¢ºçš„é©—è­‰
                    const itemExists = savedItem && typeof savedItem === 'object' && savedItem.diseaseName === diseaseName;
                    const countMatches = savedCount === afterCount; // ç²¾ç¢ºåŒ¹é…é …ç›®æ•¸
                    
                    console.log(`   é …ç›®å­˜åœ¨æª¢æŸ¥: ${itemExists}`);
                    console.log(`   é …ç›®æ•¸æª¢æŸ¥: ${countMatches}`);
                    
                    if (itemExists && countMatches) {
                        console.log(`âœ… çµ±è¨ˆæ•¸æ“šä¿å­˜é©—è­‰æˆåŠŸ`);
                    } else {
                        console.error(`âŒ çµ±è¨ˆæ•¸æ“šä¿å­˜é©—è­‰å¤±æ•—`);
                        console.log(`æœŸæœ›çµ±è¨ˆ:`, stats[key]);
                        console.log(`å¯¦éš›çµ±è¨ˆ:`, savedItem);
                        console.log(`ä¿å­˜çš„æ‰€æœ‰é …ç›®:`, Object.keys(savedStats));
                        
                        // æª¢æŸ¥ LocalStorage æ˜¯å¦çœŸçš„å­˜åœ¨
                        const rawStorage = localStorage.getItem('cmGameStudyStats');
                        const hasStats = rawStorage !== null;
                        console.log(`LocalStorage å­˜åœ¨æª¢æŸ¥: ${hasStats}`);
                        console.log(`LocalStorage æ•¸æ“šé•·åº¦: ${rawStorage ? rawStorage.length : 0} å­—ç¬¦`);
                        if (!hasStats) {
                            console.error(`âŒ LocalStorage æ ¹æœ¬æ²’æœ‰è¢«è¨­ç½®ï¼`);
                        } else {
                            console.log(`LocalStorage æ•¸æ“šç‰‡æ®µ:`, rawStorage.substring(0, 200) + '...');
                        }
                    }
                }, 100);
                
            } catch (error) {
                console.error(`âŒ çµ±è¨ˆä¿å­˜å¤±æ•—:`, error);
            }
        }

        // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== ä¸­é†«å­¸ç¿’é¸æ“‡é¡ŒéŠæˆ²åˆå§‹åŒ– ===');
            console.log('ç€è¦½å™¨:', navigator.userAgent);
            console.log('ç•¶å‰ç¶²å€:', window.location.href);
            
            // æª¢æŸ¥æ˜¯å¦é€šéæœå‹™å™¨è¨ªå•
            if (window.location.protocol === 'file:') {
                console.warn('è­¦å‘Šï¼šæ‚¨æ­£åœ¨é€šé file:// å”è­°è¨ªå•ï¼Œå¯èƒ½æœƒé‡åˆ°CORSå•é¡Œ');
                console.log('å»ºè­°ï¼šè«‹ä½¿ç”¨ Python æœå‹™å™¨å•Ÿå‹•éŠæˆ² (python server.py)');
            } else {
                console.log('âœ“ æ­£åœ¨é€šéHTTPæœå‹™å™¨è¨ªå•');
            }
            
            // ç‚ºæ‰€æœ‰checkbox-itemæ·»åŠ é»æ“Šäº‹ä»¶
            document.querySelectorAll('.checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                
                // åˆå§‹åŒ–é¸ä¸­ç‹€æ…‹æ¨£å¼
                if (checkbox) {
                    updateCheckboxItemStyle(item, checkbox.checked);
                    
                    // ç›£è½checkboxç‹€æ…‹è®ŠåŒ–
                    checkbox.addEventListener('change', function() {
                        updateCheckboxItemStyle(item, this.checked);
                    });
                }
                
                // é»æ“Šæ•´å€‹é …ç›®åˆ‡æ›checkbox
                item.addEventListener('click', function(e) {
                    // å¦‚æœé»æ“Šçš„ä¸æ˜¯checkboxæœ¬èº«ï¼Œå‰‡åˆ‡æ›checkboxç‹€æ…‹
                    if (e.target.type !== 'checkbox') {
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            // è§¸ç™¼changeäº‹ä»¶
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    }
                });
            });

            // é›£åº¦æ¨¡å¼æè¿°æ›´æ–°
            const difficultySelect = document.getElementById('difficultyMode');
            const difficultyDesc = document.getElementById('difficultyDesc');
            
            if (difficultySelect && difficultyDesc) {
                difficultySelect.addEventListener('change', function() {
                    if (this.value === 'hard') {
                        difficultyDesc.textContent = 'å›°é›£æ¨¡å¼ï¼šéŒ¯èª¤ç­”æ¡ˆåƒ…å¾ç›¸åŒç—…åçš„å…¶ä»–è­‰å‹/æ²»æ³•/æ–¹è—¥ä¸­é¸å–ï¼Œæ›´å…·æŒ‘æˆ°æ€§';
                    } else {
                        difficultyDesc.textContent = 'ä¸€èˆ¬æ¨¡å¼ï¼šéŒ¯èª¤ç­”æ¡ˆå¾æ‰€æœ‰è³‡æ–™ä¸­éš¨æ©Ÿé¸å–';
                    }
                });
            }
            
            loadDatasetFiles();
        });

        // è¼‰å…¥æ•¸æ“šé›†æ–‡ä»¶
        async function loadDatasetFiles() {
            console.log('è¼‰å…¥åŠ å¯†æ•¸æ“šé›†...');
            
            try {
                // æª¢æŸ¥æ˜¯å¦æœ‰åŠ å¯†æ•¸æ“šé›†
                if (typeof ENCRYPTED_DATASETS === 'undefined') {
                    throw new Error('åŠ å¯†æ•¸æ“šé›†æœªè¼‰å…¥');
                }

                const select = document.getElementById('subjectSelect');
                select.innerHTML = '<option value="">è«‹é¸æ“‡ç§‘ç›®...</option>';
                
                // å¾åŠ å¯†æ•¸æ“šé›†ä¸­ç²å–ç§‘ç›®åˆ—è¡¨
                const subjects = Object.keys(ENCRYPTED_DATASETS);
                console.log('å¯ç”¨ç§‘ç›®:', subjects);
                
                subjects.forEach(subjectKey => {
                    const option = document.createElement('option');
                    option.value = subjectKey;
                    // å°‡éµåè½‰æ›ç‚ºé¡¯ç¤ºåç¨±
                    const displayName = subjectKey.includes('_') ? subjectKey.split('_').slice(1).join('_') : subjectKey;
                    option.textContent = displayName;
                    select.appendChild(option);
                });

                // è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹ç§‘ç›®
                if (subjects.length > 0) {
                    select.value = subjects[0];
                    const displayName = subjects[0].includes('_') ? subjects[0].split('_').slice(1).join('_') : subjects[0];
                    console.log('å·²è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹ç§‘ç›®:', displayName);
                }

                console.log('ç§‘ç›®é¸é …å·²è¼‰å…¥å®Œæˆ');

            } catch (error) {
                console.error('è¼‰å…¥åŠ å¯†æ•¸æ“šé›†å¤±æ•—:', error);
                // å‚™ç”¨æ–¹æ¡ˆï¼šæä¾›é è¨­ç§‘ç›®é¸é …
                const select = document.getElementById('subjectSelect');
                select.innerHTML = `
                    <option value="">è«‹é¸æ“‡ç§‘ç›®...</option>
                    <option value="01_å…§ç§‘">å…§ç§‘</option>
                    <option value="02_å©¦ç§‘">å©¦ç§‘</option>
                    <option value="03_å…’ç§‘">å…’ç§‘</option>
                `;
                
                select.value = "01_å…§ç§‘";
                console.log('ä½¿ç”¨å‚™ç”¨é è¨­ç§‘ç›®é¸é …');
            }
        }

        // è¼‰å…¥ä¸¦è§£å¯†æ•¸æ“š
        async function loadCSVData(subjectKey) {
            try {
                console.log('æ­£åœ¨è¼‰å…¥åŠ å¯†æ•¸æ“š:', subjectKey);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰åŠ å¯†æ•¸æ“šé›†
                if (typeof ENCRYPTED_DATASETS === 'undefined') {
                    throw new Error('åŠ å¯†æ•¸æ“šé›†æœªè¼‰å…¥');
                }
                
                // ç²å–å°æ‡‰çš„åŠ å¯†æ•¸æ“š
                const encryptedData = ENCRYPTED_DATASETS[subjectKey];
                if (!encryptedData) {
                    throw new Error(`æ‰¾ä¸åˆ°ç§‘ç›®æ•¸æ“š: ${subjectKey}`);
                }
                
                console.log('åŠ å¯†æ•¸æ“šé•·åº¦:', encryptedData.length, 'å­—ç¬¦');
                
                // è§£å¯†æ•¸æ“š (Base64è§£ç¢¼) - æ”¯æŒUTF-8å­—ç¬¦
                let decodedData;
                try {
                    // ä½¿ç”¨æ­£ç¢ºçš„UTF-8 Base64è§£ç¢¼æ–¹æ³•
                    const binaryString = atob(encryptedData);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    decodedData = new TextDecoder('utf-8').decode(bytes);
                    console.log('è§£å¯†å¾Œæ•¸æ“šé•·åº¦:', decodedData.length, 'å­—ç¬¦');
                } catch (error) {
                    throw new Error('æ•¸æ“šè§£å¯†å¤±æ•—: ' + error.message);
                }
                
                // è§£æJSONæ•¸æ“š
                let jsonData;
                try {
                    // Fix unquoted 'ahyy' values in the JSON before parsing
                    // ä½¿ç”¨æ›´ç²¾ç¢ºçš„æ­£å‰‡è¡¨é”å¼ä¾†è™•ç† ahyy å€¼
                    const fixedData = decodedData.replace(/:\s*ahyy\b/g, ': "ahyy"');
                    jsonData = JSON.parse(fixedData);
                    console.log('è§£æå¾Œæ•¸æ“šæ¢æ•¸:', jsonData.length);
                    console.log('æ•¸æ“šè§£ç¢¼å’Œè§£æå®Œæˆï¼ŒåŒ…å«ä¸­æ–‡å­—ç¬¦');
                } catch (error) {
                    console.error('JSONè§£æéŒ¯èª¤è©³æƒ…:', error);
                    console.error('æ•¸æ“šæ¨£æœ¬:', decodedData.substring(0, 200));
                    throw new Error('JSONè§£æå¤±æ•—: ' + error.message);
                }
                
                if (!Array.isArray(jsonData) || jsonData.length === 0) {
                    throw new Error('æ•¸æ“šæ ¼å¼éŒ¯èª¤æˆ–ç‚ºç©º');
                }
                
                // é©—è­‰æ•¸æ“šçµæ§‹
                const sampleRow = jsonData[0];
                const requiredFields = ['ç—…å', 'è­‰å‹', 'æ²»æ³•', 'æ–¹è—¥', 'è­‰å€™'];
                const missingFields = requiredFields.filter(field => !(field in sampleRow));
                
                if (missingFields.length > 0) {
                    console.warn('éƒ¨åˆ†å¿…è¦æ¬„ä½ç¼ºå¤±:', missingFields);
                }
                
                console.log('å¯ç”¨æ¬„ä½:', Object.keys(sampleRow));
                console.log('å‰3æ¢æ•¸æ“šç¯„ä¾‹:', jsonData.slice(0, 3));
                
                return jsonData;
                
            } catch (error) {
                console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
                alert('è¼‰å…¥æ•¸æ“šå¤±æ•—: ' + error.message + '\n\nè«‹æª¢æŸ¥:\n1. åŠ å¯†æ•¸æ“šé›†æ˜¯å¦æ­£ç¢ºè¼‰å…¥\n2. æ•¸æ“šæ ¼å¼æ˜¯å¦æ­£ç¢º\n3. ç§‘ç›®åç¨±æ˜¯å¦åŒ¹é…');
                return [];
            }
        }

        // ç²å–é¸ä¸­çš„é¸é …
        function getCheckedValues(containerId) {
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // ç”Ÿæˆé¡Œç›®
        function generateQuestions(data, questionInfo, answerInfo, count) {
            console.log('é–‹å§‹ç”Ÿæˆé¡Œç›®ï¼Œæ•¸æ“šé‡:', data.length);
            const questions = [];
            const usedCombinations = new Set();
            let attempts = 0;
            const maxAttempts = count * 20; // å¢åŠ å˜—è©¦æ¬¡æ•¸ä»¥ç²å¾—æ›´å¤šæ¨£åŒ–çš„çµ„åˆ

            while (questions.length < count && attempts < maxAttempts) {
                attempts++;
                const randomRow = data[Math.floor(Math.random() * data.length)];
                
                // æª¢æŸ¥æ‰€éœ€æ¬„ä½æ˜¯å¦æœ‰å€¼
                const hasQuestionInfo = questionInfo.every(info => randomRow[info] && randomRow[info].trim() !== '');
                const hasAnswerInfo = answerInfo.every(info => randomRow[info] && randomRow[info].trim() !== '');
                
                if (!hasQuestionInfo || !hasAnswerInfo) {
                    continue; // è·³éè³‡æ–™ä¸å®Œæ•´çš„è¡Œ
                }
                
                // ä½¿ç”¨ç—…å+è­‰å‹å‰µå»ºå”¯ä¸€æ¨™è­˜ç¬¦ï¼Œè€Œä¸æ˜¯å•é¡Œè³‡è¨Š
                // é€™æ¨£å¯ä»¥ç¢ºä¿æ¯å€‹ç—…åè­‰å‹çµ„åˆéƒ½æœ‰æ©Ÿæœƒè¢«é¸ä¸­
                const diseaseName = randomRow['ç—…å'] || '';
                const syndromeType = randomRow['è­‰å‹'] || '';
                const uniqueKey = `${diseaseName}_${syndromeType}`;
                
                console.log(`å˜—è©¦ ${attempts}: ${uniqueKey}`);
                
                if (usedCombinations.has(uniqueKey)) {
                    console.log(`è·³éé‡è¤‡çµ„åˆ: ${uniqueKey}`);
                    continue;
                }
                usedCombinations.add(uniqueKey);
                console.log(`æ·»åŠ æ–°çµ„åˆ: ${uniqueKey}`);

                // æ§‹å»ºå•é¡Œæ–‡æœ¬
                let questionText = 'æ ¹æ“šä»¥ä¸‹è³‡è¨Šï¼š\n';
                questionInfo.forEach(info => {
                    if (randomRow[info] && randomRow[info].trim()) {
                        questionText += `${info}ï¼š${randomRow[info]}\n`;
                    }
                });
                questionText += `\nè«‹é¸æ“‡æ­£ç¢ºçš„${answerInfo.join('ã€')}ï¼š`;

                // æ§‹å»ºæ­£ç¢ºç­”æ¡ˆ
                const correctAnswer = answerInfo.map(info => {
                    return (randomRow[info] && randomRow[info].trim()) ? `${info}ï¼š${randomRow[info]}` : '';
                }).filter(item => item).join('\n');

                if (correctAnswer.trim()) {
                    questions.push({
                        question: questionText,
                        correctAnswer: correctAnswer,
                        data: randomRow,
                        questionInfo: questionInfo,
                        answerInfo: answerInfo
                    });
                    
                    console.log(`ç”Ÿæˆç¬¬ ${questions.length} é¡Œ`);
                }
            }

            console.log(`ç¸½å…±ç”Ÿæˆ ${questions.length} é¡Œï¼Œå˜—è©¦ ${attempts} æ¬¡`);
            return questions;
        }

        // ç”Ÿæˆç­”æ¡ˆé¸é …
        function generateAnswerOptions(question, allData, optionCount, difficultyMode = 'normal') {
            const options = [question.correctAnswer];
            const usedAnswers = new Set([question.correctAnswer]);
            let attempts = 0;
            const maxAttempts = optionCount * 50; // å¢åŠ å˜—è©¦æ¬¡æ•¸ä»¥é©æ‡‰å›°é›£æ¨¡å¼

            // ç²å–å€™é¸æ•¸æ“šæ± 
            let candidateData = allData;
            if (difficultyMode === 'hard') {
                // å›°é›£æ¨¡å¼ï¼šåªå¾ç›¸åŒç—…åçš„è³‡æ–™ä¸­é¸å–
                const correctDiseaseName = question.data['ç—…å'];
                if (correctDiseaseName) {
                    candidateData = allData.filter(row => 
                        row['ç—…å'] === correctDiseaseName && 
                        row !== question.data // æ’é™¤æ­£ç¢ºç­”æ¡ˆæœ¬èº«
                    );
                    console.log(`å›°é›£æ¨¡å¼ï¼šå¾ ${candidateData.length} å€‹ç›¸åŒç—…åã€Œ${correctDiseaseName}ã€çš„è³‡æ–™ä¸­é¸å–éŒ¯èª¤ç­”æ¡ˆ`);
                    
                    // å¦‚æœåŒç—…åçš„è³‡æ–™ä¸è¶³ï¼Œé™ç´šç‚ºæ™®é€šæ¨¡å¼
                    if (candidateData.length < optionCount - 1) {
                        console.log('åŒç—…åè³‡æ–™ä¸è¶³ï¼Œé™ç´šç‚ºä¸€èˆ¬æ¨¡å¼');
                        candidateData = allData;
                        difficultyMode = 'normal';
                    }
                }
            }

            while (options.length < optionCount && attempts < maxAttempts) {
                attempts++;
                const randomRow = candidateData[Math.floor(Math.random() * candidateData.length)];
                
                // æª¢æŸ¥éš¨æ©Ÿè¡Œæ˜¯å¦æœ‰æ‰€éœ€çš„ç­”æ¡ˆè³‡è¨Š
                const hasAnswerData = question.answerInfo.every(info => 
                    randomRow[info] && randomRow[info].trim() !== ''
                );
                
                if (!hasAnswerData) {
                    continue;
                }
                
                const fakeAnswer = question.answerInfo.map(info => {
                    return (randomRow[info] && randomRow[info].trim()) ? `${info}ï¼š${randomRow[info]}` : '';
                }).filter(item => item).join('\n');

                if (fakeAnswer.trim() && 
                    !usedAnswers.has(fakeAnswer) && 
                    fakeAnswer !== question.correctAnswer) {
                    options.push(fakeAnswer);
                    usedAnswers.add(fakeAnswer);
                }
            }

            // å¦‚æœç„¡æ³•ç”Ÿæˆè¶³å¤ çš„é¸é …ï¼Œç”¨ä½”ä½ç¬¦å¡«å……
            while (options.length < optionCount) {
                const placeholderAnswer = question.answerInfo.map(info => 
                    `${info}ï¼š[é¸é … ${options.length}]`
                ).join('\n');
                
                if (!usedAnswers.has(placeholderAnswer)) {
                    options.push(placeholderAnswer);
                    usedAnswers.add(placeholderAnswer);
                }
            }

            console.log(`${difficultyMode === 'hard' ? 'å›°é›£æ¨¡å¼' : 'ä¸€èˆ¬æ¨¡å¼'}ï¼šç‚ºé¡Œç›®ç”Ÿæˆäº† ${options.length} å€‹é¸é …`);
            
            // éš¨æ©Ÿæ’åºé¸é …
            return options.sort(() => Math.random() - 0.5);
        }

        // é–‹å§‹æ¸¬é©—
        async function startQuiz() {
            console.log('é–‹å§‹æ¸¬é©—...');
            
            const selectedSubject = document.getElementById('subjectSelect').value;
            const questionInfo = getCheckedValues('questionInfo');
            const answerInfo = getCheckedValues('answerInfo');
            const optionCount = parseInt(document.getElementById('optionCount').value);
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const difficultyMode = document.getElementById('difficultyMode').value;

            console.log('æ¸¬é©—è¨­å®š:', {
                ç§‘ç›®: selectedSubject,
                å•é¡Œè³‡è¨Š: questionInfo,
                ç­”æ¡ˆè³‡è¨Š: answerInfo,
                é¸é …æ•¸é‡: optionCount,
                å•é¡Œæ•¸é‡: questionCount,
                é›£åº¦æ¨¡å¼: difficultyMode
            });

            // é©—è­‰è¨­å®š
            if (!selectedSubject) {
                alert('è«‹é¸æ“‡ç§‘ç›®');
                return;
            }
            if (questionInfo.length === 0) {
                alert('è«‹é¸æ“‡è‡³å°‘ä¸€é …å•é¡Œè³‡è¨Š');
                return;
            }
            if (answerInfo.length === 0) {
                alert('è«‹é¸æ“‡è‡³å°‘ä¸€é …ç­”æ¡ˆè³‡è¨Š');
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            const startButton = document.querySelector('button[onclick="startQuiz()"]');
            const originalText = startButton.textContent;
            startButton.textContent = 'ğŸ”„ è¼‰å…¥ä¸­...';
            startButton.disabled = true;

            try {
                // è¼‰å…¥æ•¸æ“š
                console.log('æ­£åœ¨è¼‰å…¥æ•¸æ“š...');
                currentDataset = await loadCSVData(selectedSubject);
                
                if (currentDataset.length === 0) {
                    throw new Error('æ•¸æ“šè¼‰å…¥å¤±æ•—æˆ–æ•¸æ“šç‚ºç©º');
                }

                console.log('æ•¸æ“šè¼‰å…¥æˆåŠŸï¼Œå…±', currentDataset.length, 'æ¢è¨˜éŒ„');

                // æª¢æŸ¥æ•¸æ“šä¸­æ˜¯å¦åŒ…å«æ‰€éœ€æ¬„ä½
                const sampleRow = currentDataset[0];
                const missingFields = [];
                
                questionInfo.forEach(field => {
                    if (!(field in sampleRow)) {
                        missingFields.push(field);
                    }
                });
                
                answerInfo.forEach(field => {
                    if (!(field in sampleRow)) {
                        missingFields.push(field);
                    }
                });

                if (missingFields.length > 0) {
                    throw new Error(`æ•¸æ“šä¸­ç¼ºå°‘å¿…è¦æ¬„ä½: ${missingFields.join(', ')}\n\nå¯ç”¨æ¬„ä½: ${Object.keys(sampleRow).join(', ')}`);
                }

                // ç”Ÿæˆé¡Œç›®
                console.log('æ­£åœ¨ç”Ÿæˆé¡Œç›®...');
                
                // è¨˜éŒ„æ‰€æœ‰å¯èƒ½çš„ç—…åè­‰å‹çµ„åˆ
                const allCombinations = new Set();
                currentDataset.forEach(row => {
                    if (row['ç—…å'] && row['è­‰å‹']) {
                        allCombinations.add(`${row['ç—…å']}_${row['è­‰å‹']}`);
                    }
                });
                console.log(`ğŸ¯ æ•¸æ“šé›†ä¸­å…±æœ‰ ${allCombinations.size} ç¨®ä¸åŒçš„ç—…åè­‰å‹çµ„åˆ`);
                
                currentQuestions = generateQuestions(currentDataset, questionInfo, answerInfo, questionCount);
                
                if (currentQuestions.length === 0) {
                    throw new Error('ç„¡æ³•ç”Ÿæˆé¡Œç›®ï¼Œè«‹æª¢æŸ¥æ•¸æ“šæˆ–èª¿æ•´è¨­å®š');
                }

                console.log('æˆåŠŸç”Ÿæˆ', currentQuestions.length, 'é“é¡Œç›®');

                // çµ±è¨ˆæœ¬æ¬¡æ¸¬é©—å°‡åŒ…å«çš„ç—…åè­‰å‹çµ„åˆ
                const testCombinations = new Set();
                currentQuestions.forEach((q, index) => {
                    if (q.data['ç—…å'] && q.data['è­‰å‹']) {
                        const combo = `${q.data['ç—…å']}_${q.data['è­‰å‹']}`;
                        testCombinations.add(combo);
                        console.log(`ç¬¬${index + 1}é¡Œ: ${combo}`);
                    }
                });
                console.log(`ğŸ“Š æœ¬æ¬¡æ¸¬é©—åŒ…å« ${testCombinations.size} ç¨®ä¸åŒçš„ç—…åè­‰å‹çµ„åˆ`);
                console.log('æœ¬æ¬¡æ¸¬é©—çš„çµ„åˆ:', Array.from(testCombinations));

                // åˆå§‹åŒ–æ¸¬é©—ç‹€æ…‹
                currentQuestionIndex = 0;
                score = 0;
                totalQuestions = currentQuestions.length;
                questionAnswered = false;
                currentDifficultyMode = difficultyMode;
                questionResults = []; // é‡ç½®çµ±è¨ˆæ•¸æ“š

                // åˆ‡æ›ç•Œé¢
                document.getElementById('setupSection').style.display = 'none';
                document.getElementById('quizSection').style.display = 'block';

                // é¡¯ç¤ºç¬¬ä¸€é¡Œ
                showCurrentQuestion();

            } catch (error) {
                console.error('å•Ÿå‹•æ¸¬é©—å¤±æ•—:', error);
                alert('å•Ÿå‹•æ¸¬é©—å¤±æ•—:\n\n' + error.message);
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                startButton.textContent = originalText;
                startButton.disabled = false;
            }
        }

        // é¡¯ç¤ºç•¶å‰é¡Œç›®
        function showCurrentQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                showFinalScore();
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            const optionCount = parseInt(document.getElementById('optionCount').value);

            // æ·»åŠ æ•¸æ“šçµæ§‹æª¢æŸ¥
            console.log('=== é¡¯ç¤ºå•é¡Œæ™‚çš„æ•¸æ“šæª¢æŸ¥ ===');
            console.log('å•é¡Œç´¢å¼•:', currentQuestionIndex);
            console.log('å®Œæ•´å•é¡Œå°è±¡:', question);
            console.log('å•é¡Œæ•¸æ“š (question.data):', question.data);
            if (question.data) {
                console.log('æ•¸æ“šæ¬„ä½:', Object.keys(question.data));
                console.log('ç—…åæ¬„ä½å€¼:', question.data['ç—…å']);
                console.log('è­‰å‹æ¬„ä½å€¼:', question.data['è­‰å‹']);
            } else {
                console.error('âš ï¸ å•é¡Œæ²’æœ‰ data å±¬æ€§ï¼');
            }

            // æ›´æ–°é€²åº¦
            const progress = ((currentQuestionIndex) / totalQuestions) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // æ›´æ–°é¡Œç›®ä¿¡æ¯
            document.getElementById('questionNumber').textContent = 
                `ç¬¬ ${currentQuestionIndex + 1} é¡Œ / å…± ${totalQuestions} é¡Œ`;
            document.getElementById('questionText').textContent = question.question;

            // ç”Ÿæˆç­”æ¡ˆé¸é …
            const options = generateAnswerOptions(question, currentDataset, optionCount, currentDifficultyMode);
            const optionsContainer = document.getElementById('answerOptions');
            optionsContainer.innerHTML = '';

            options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'answer-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectAnswer(optionDiv, option);
                optionsContainer.appendChild(optionDiv);
            });

            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            questionAnswered = false;
            document.getElementById('showAnswerBtn').style.display = 'inline-block';
            document.getElementById('nextQuestionBtn').style.display = 'none';

            // æ¸…é™¤æ‰€æœ‰é¸é …çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.answer-option').forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
                option.style.pointerEvents = 'auto'; // é‡æ–°å•Ÿç”¨é»æ“Š
            });
        }

        // é¸æ“‡ç­”æ¡ˆ
        function selectAnswer(element, answer) {
            if (questionAnswered) return;

            // ç«‹å³æ¨™è¨˜ç‚ºå·²å›ç­”
            questionAnswered = true;
            const question = currentQuestions[currentQuestionIndex];
            const isCorrect = element.textContent === question.correctAnswer;

            // æ›´æ–°Cookieçµ±è¨ˆï¼ˆå¦‚æœå•é¡ŒåŒ…å«ç—…åå’Œè­‰å‹ï¼‰
            const diseaseName = question.data['ç—…å'];
            const syndromeType = question.data['è­‰å‹'];
            console.log('ç­”é¡Œçµ±è¨ˆæª¢æŸ¥:');
            console.log('å•é¡Œæ•¸æ“š:', question.data);
            console.log('ç—…å:', diseaseName);
            console.log('è­‰å‹:', syndromeType);
            
            if (diseaseName && syndromeType) {
                console.log('é–‹å§‹æ›´æ–°çµ±è¨ˆ...');
                updateStudyStats(diseaseName, syndromeType, isCorrect);
            } else {
                console.log('âš ï¸ è·³éçµ±è¨ˆæ›´æ–°ï¼šç¼ºå°‘ç—…åæˆ–è­‰å‹');
                console.log('å¯ç”¨æ¬„ä½:', Object.keys(question.data));
            }

            // è¨˜éŒ„ç­”é¡Œçµæœ
            const questionResult = {
                questionNumber: currentQuestionIndex + 1,
                question: question.question,
                userAnswer: element.textContent,
                correctAnswer: question.correctAnswer,
                isCorrect: isCorrect,
                timestamp: new Date(),
                diseaseName: diseaseName,
                syndromeType: syndromeType
            };
            questionResults.push(questionResult);

            // æ¸…é™¤å…¶ä»–é¸é …çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.answer-option').forEach(option => {
                option.classList.remove('selected');
                option.style.pointerEvents = 'none'; // ç¦ç”¨é»æ“Š
            });

            // æ¨™è¨˜ç•¶å‰é¸é …ç‚ºé¸ä¸­
            element.classList.add('selected');

            // ç«‹å³é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆå’Œçµæœ
            document.querySelectorAll('.answer-option').forEach(option => {
                if (option.textContent === question.correctAnswer) {
                    option.classList.add('correct');
                } else if (option.classList.contains('selected')) {
                    option.classList.add('incorrect');
                }
            });

            // è¨ˆåˆ†ï¼ˆç­”å°æ™‚åŠ åˆ†ï¼‰
            if (isCorrect) {
                score++;
            }

            // æ›´æ–°æŒ‰éˆ•
            document.getElementById('showAnswerBtn').style.display = 'none';
            document.getElementById('nextQuestionBtn').style.display = 'inline-block';
        }

        // é¡¯ç¤ºç­”æ¡ˆï¼ˆç”±æ–¼é¸æ“‡ç­”æ¡ˆæ™‚å·²ç¶“é¡¯ç¤ºï¼Œé€™å€‹å‡½æ•¸ç¾åœ¨ä¸»è¦ç”¨æ–¼æœªé¸æ“‡æ™‚å¼·åˆ¶é¡¯ç¤ºç­”æ¡ˆï¼‰
        function showAnswer() {
            if (questionAnswered) return;

            questionAnswered = true;
            const question = currentQuestions[currentQuestionIndex];

            // æ›´æ–°Cookieçµ±è¨ˆï¼ˆè·³éç®—ä½œéŒ¯èª¤ï¼‰
            const diseaseName = question.data['ç—…å'];
            const syndromeType = question.data['è­‰å‹'];
            console.log('è·³éç­”æ¡ˆçµ±è¨ˆæª¢æŸ¥:');
            console.log('å•é¡Œæ•¸æ“š:', question.data);
            console.log('ç—…å:', diseaseName);
            console.log('è­‰å‹:', syndromeType);
            
            if (diseaseName && syndromeType) {
                console.log('é–‹å§‹æ›´æ–°çµ±è¨ˆï¼ˆè·³éç­”æ¡ˆï¼‰...');
                updateStudyStats(diseaseName, syndromeType, false);
            } else {
                console.log('âš ï¸ è·³éçµ±è¨ˆæ›´æ–°ï¼šç¼ºå°‘ç—…åæˆ–è­‰å‹');
                console.log('å¯ç”¨æ¬„ä½:', Object.keys(question.data));
            }

            // è¨˜éŒ„æœªé¸æ“‡ç­”æ¡ˆçš„çµæœ
            const questionResult = {
                questionNumber: currentQuestionIndex + 1,
                question: question.question,
                userAnswer: 'æœªé¸æ“‡',
                correctAnswer: question.correctAnswer,
                isCorrect: false,
                timestamp: new Date(),
                diseaseName: diseaseName,
                syndromeType: syndromeType
            };
            questionResults.push(questionResult);

            // ç¦ç”¨æ‰€æœ‰é¸é …çš„é»æ“Š
            document.querySelectorAll('.answer-option').forEach(option => {
                option.style.pointerEvents = 'none';
            });

            // æ¨™è¨˜æ­£ç¢ºç­”æ¡ˆ
            document.querySelectorAll('.answer-option').forEach(option => {
                if (option.textContent === question.correctAnswer) {
                    option.classList.add('correct');
                }
            });

            // æ›´æ–°æŒ‰éˆ•
            document.getElementById('showAnswerBtn').style.display = 'none';
            document.getElementById('nextQuestionBtn').style.display = 'inline-block';
        }

        // ä¸‹ä¸€é¡Œ
        function nextQuestion() {
            currentQuestionIndex++;
            showCurrentQuestion();
        }

        // é¡¯ç¤ºæœ€çµ‚åˆ†æ•¸
        function showFinalScore() {
            const percentage = Math.round((score / totalQuestions) * 100);
            
            // çµ±è¨ˆæœ¬æ¬¡æ¸¬é©—çš„å­¸ç¿’æ•¸æ“šæ›´æ–°
            console.log('=== æ¸¬é©—çµæŸçµ±è¨ˆæ‘˜è¦ ===');
            const finalStats = getStudyStats();
            console.log('æœ€çµ‚çµ±è¨ˆé …ç›®ç¸½æ•¸:', Object.keys(finalStats).length);
            
            // çµ±è¨ˆæœ¬æ¬¡æ¸¬é©—æ¶‰åŠçš„ç—…åè­‰å‹çµ„åˆ
            const thisTestCombinations = new Set();
            currentQuestions.forEach(q => {
                if (q.data['ç—…å'] && q.data['è­‰å‹']) {
                    thisTestCombinations.add(`${q.data['ç—…å']}_${q.data['è­‰å‹']}`);
                }
            });
            console.log(`æœ¬æ¬¡æ¸¬é©—æ¶‰åŠ ${thisTestCombinations.size} ç¨®ç—…åè­‰å‹çµ„åˆ:`, Array.from(thisTestCombinations));
            
            // æª¢æŸ¥é€™äº›çµ„åˆåœ¨çµ±è¨ˆä¸­çš„å­˜åœ¨æƒ…æ³
            let updatedCount = 0;
            thisTestCombinations.forEach(combo => {
                if (finalStats[combo]) {
                    updatedCount++;
                    console.log(`âœ… ${combo}: ç¸½æ¬¡æ•¸ ${finalStats[combo].totalAttempts}, æ­£ç¢ºæ¬¡æ•¸ ${finalStats[combo].correctAttempts}`);
                } else {
                    console.log(`âŒ ${combo}: æœªåœ¨çµ±è¨ˆä¸­æ‰¾åˆ°`);
                }
            });
            console.log(`ğŸ“Š æˆåŠŸæ›´æ–°äº† ${updatedCount}/${thisTestCombinations.size} å€‹çµ„åˆçš„çµ±è¨ˆæ•¸æ“š`);
            
            document.getElementById('quizSection').style.display = 'none';
            document.getElementById('finalScoreSection').classList.remove('hidden');
            
            document.getElementById('finalScore').textContent = `${score}/${totalQuestions} (${percentage}%)`;
            
            let message = '';
            if (percentage >= 90) {
                message = 'ğŸ† å„ªç§€ï¼æ‚¨å°ä¸­é†«ç†è«–æŒæ¡å¾—å¾ˆå¥½ï¼';
            } else if (percentage >= 80) {
                message = 'ğŸ‘ è‰¯å¥½ï¼ç¹¼çºŒåŠ æ²¹å­¸ç¿’ï¼';
            } else if (percentage >= 60) {
                message = 'ğŸ“š åŠæ ¼ï¼é‚„æœ‰é€²æ­¥ç©ºé–“ï¼Œå»ºè­°å¤šè¤‡ç¿’ï¼';
            } else {
                message = 'ğŸ’ª éœ€è¦åŠ å¼·ï¼å»ºè­°é‡æ–°å­¸ç¿’ç›¸é—œçŸ¥è­˜é»ï¼';
            }
            
            document.getElementById('scoreMessage').textContent = message;
            
            // ç”Ÿæˆçµ±è¨ˆå ±å‘Š
            generateStatisticsReport();
        }

        // ç”Ÿæˆçµ±è¨ˆå ±å‘Š
        function generateStatisticsReport() {
            const correctAnswers = questionResults.filter(r => r.isCorrect).length;
            const incorrectAnswers = questionResults.filter(r => !r.isCorrect).length;
            const skippedAnswers = questionResults.filter(r => r.userAnswer === 'æœªé¸æ“‡').length;
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            // è¨ˆç®—å¹³å‡ç­”é¡Œæ™‚é–“ï¼ˆå¦‚æœæœ‰æ™‚é–“æˆ³è¨˜éŒ„ï¼‰
            let avgTime = 0;
            if (questionResults.length > 1) {
                const totalTime = questionResults[questionResults.length - 1].timestamp - questionResults[0].timestamp;
                avgTime = Math.round(totalTime / questionResults.length / 1000); // ç§’
            }
            
            // ç”Ÿæˆçµ±è¨ˆæ‘˜è¦
            const statsSummary = document.getElementById('statsSummary');
            statsSummary.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${correctAnswers}</div>
                    <div class="stat-label">ç­”å°é¡Œæ•¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${incorrectAnswers}</div>
                    <div class="stat-label">ç­”éŒ¯é¡Œæ•¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${skippedAnswers}</div>
                    <div class="stat-label">è·³éé¡Œæ•¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${percentage}%</div>
                    <div class="stat-label">æ­£ç¢ºç‡</div>
                </div>
                ${avgTime > 0 ? `
                <div class="stat-item">
                    <div class="stat-value">${avgTime}s</div>
                    <div class="stat-label">å¹³å‡ç­”é¡Œæ™‚é–“</div>
                </div>
                ` : ''}
            `;
            
            // ç”Ÿæˆè©³ç´°é¡Œç›®å ±å‘Š
            const statsDetails = document.getElementById('statsDetails');
            let detailsHTML = '<h4 style="color: white; margin-bottom: 15px;">ğŸ“‹ é¡Œç›®è©³ç´°åˆ†æ</h4>';
            
            questionResults.forEach((result, index) => {
                detailsHTML += `
                    <div class="question-result ${result.isCorrect ? 'correct' : 'incorrect'}">
                        <div class="question-result-header">
                            ${result.isCorrect ? 'âœ…' : 'âŒ'} ç¬¬ ${result.questionNumber} é¡Œ
                        </div>
                        <div class="question-result-content">
                            <div><strong>é¡Œç›®ï¼š</strong></div>
                            <div style="white-space: pre-line; margin: 8px 0; font-size: 0.9em;">${result.question}</div>
                            
                            <div class="user-answer ${result.isCorrect ? 'correct' : 'incorrect'}">
                                <strong>æ‚¨çš„ç­”æ¡ˆï¼š</strong><br>
                                ${result.userAnswer}
                            </div>
                            
                            ${!result.isCorrect ? `
                            <div class="correct-answer">
                                <strong>æ­£ç¢ºç­”æ¡ˆï¼š</strong><br>
                                ${result.correctAnswer}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            statsDetails.innerHTML = detailsHTML;
        }

        // åˆ‡æ›è©³ç´°çµ±è¨ˆé¡¯ç¤º
        function toggleStatsDetails() {
            const statsDetails = document.getElementById('statsDetails');
            const toggleBtn = document.getElementById('toggleStatsBtn');
            
            if (statsDetails.classList.contains('show')) {
                statsDetails.classList.remove('show');
                toggleBtn.textContent = 'é¡¯ç¤ºè©³ç´°å ±å‘Š';
            } else {
                statsDetails.classList.add('show');
                toggleBtn.textContent = 'éš±è—è©³ç´°å ±å‘Š';
            }
        }

        // çµæŸæ¸¬é©—
        function endQuiz() {
            if (confirm('ç¢ºå®šè¦çµæŸæ¸¬é©—å—ï¼Ÿ')) {
                showFinalScore();
            }
        }

        // é‡æ–°é–‹å§‹éŠæˆ²
        function restartGame() {
            document.getElementById('finalScoreSection').classList.add('hidden');
            document.getElementById('quizSection').style.display = 'none';
            document.getElementById('setupSection').style.display = 'block';
            
            // é‡ç½®ç‹€æ…‹
            currentQuestions = [];
            currentQuestionIndex = 0;
            score = 0;
            totalQuestions = 0;
            questionAnswered = false;
            currentDifficultyMode = 'normal';
            questionResults = []; // é‡ç½®çµ±è¨ˆæ•¸æ“š
            
            // é‡ç½®è©³ç´°å ±å‘Šé¡¯ç¤ºç‹€æ…‹
            const statsDetails = document.getElementById('statsDetails');
            const toggleBtn = document.getElementById('toggleStatsBtn');
            if (statsDetails) {
                statsDetails.classList.remove('show');
            }
            if (toggleBtn) {
                toggleBtn.textContent = 'é¡¯ç¤ºè©³ç´°å ±å‘Š';
            }
        }

        // æ¸¬è©¦æ•¸æ“šè¼‰å…¥åŠŸèƒ½
        async function testDataLoad() {
            const selectedSubject = document.getElementById('subjectSelect').value;
            
            if (!selectedSubject) {
                alert('è«‹å…ˆé¸æ“‡ç§‘ç›®');
                return;
            }
            
            console.log('=== é–‹å§‹æ¸¬è©¦æ•¸æ“šè¼‰å…¥ ===');
            
            try {
                const data = await loadCSVData(selectedSubject);
                
                if (data.length > 0) {
                    const sample = data[0];
                    const message = `âœ… æ•¸æ“šè¼‰å…¥æˆåŠŸï¼\n\n` +
                        `æ–‡ä»¶ï¼š${selectedSubject}\n` +
                        `è¨˜éŒ„æ•¸ï¼š${data.length}\n` +
                        `å¯ç”¨æ¬„ä½ï¼š${Object.keys(sample).join(', ')}\n\n` +
                        `ç¬¬ä¸€æ¢è¨˜éŒ„ç¯„ä¾‹ï¼š\n${JSON.stringify(sample, null, 2)}`;
                    
                    alert(message);
                    console.log('è¼‰å…¥çš„æ•¸æ“š:', data);
                } else {
                    alert('âŒ æ•¸æ“šè¼‰å…¥å¤±æ•—æˆ–ç‚ºç©º');
                }
                
            } catch (error) {
                alert('âŒ æ¸¬è©¦å¤±æ•—ï¼š' + error.message);
                console.error('æ¸¬è©¦éŒ¯èª¤:', error);
            }
        }

        // æ¸¬è©¦ç·¨ç¢¼ä¿®å¾©åŠŸèƒ½
        async function testEncodingFix() {
            console.log('=== é–‹å§‹æ¸¬è©¦ç·¨ç¢¼ä¿®å¾© ===');
            
            try {
                // æª¢æŸ¥æ˜¯å¦æœ‰åŠ å¯†æ•¸æ“šé›†
                if (typeof ENCRYPTED_DATASETS === 'undefined') {
                    alert('âŒ ç„¡æ³•è¼‰å…¥åŠ å¯†æ•¸æ“šé›†');
                    return;
                }
                
                const testSubject = '01_å…§ç§‘';
                const encryptedData = ENCRYPTED_DATASETS[testSubject];
                
                if (!encryptedData) {
                    alert('âŒ ç„¡æ³•æ‰¾åˆ°æ¸¬è©¦æ•¸æ“š');
                    return;
                }
                
                let testResults = 'ğŸ”§ ç·¨ç¢¼ä¿®å¾©æ¸¬è©¦çµæœï¼š\n\n';
                testResults += `æ¸¬è©¦ç§‘ç›®ï¼š${testSubject}\n`;
                testResults += `åŠ å¯†æ•¸æ“šé•·åº¦ï¼š${encryptedData.length} å­—ç¬¦\n\n`;
                
                // æ¸¬è©¦è§£ç¢¼
                try {
                    const binaryString = atob(encryptedData);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    const decodedData = new TextDecoder('utf-8').decode(bytes);
                    
                    testResults += `âœ… UTF-8 è§£ç¢¼æˆåŠŸ\n`;
                    testResults += `è§£ç¢¼å¾Œé•·åº¦ï¼š${decodedData.length} å­—ç¬¦\n\n`;
                    
                    // æª¢æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
                    const chineseMatches = decodedData.match(/[\u4e00-\u9fff]/g);
                    if (chineseMatches) {
                        testResults += `âœ… åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼š${chineseMatches.length} å€‹\n`;
                        testResults += `å‰10å€‹ä¸­æ–‡å­—ç¬¦ï¼š${chineseMatches.slice(0, 10).join('')}\n\n`;
                    } else {
                        testResults += `âš ï¸ æœªæª¢æ¸¬åˆ°ä¸­æ–‡å­—ç¬¦\n\n`;
                    }
                    
                    // æ¸¬è©¦JSONè§£æ
                    try {
                        const fixedData = decodedData.replace(/:\s*ahyy\b/g, ': "ahyy"');
                        const jsonData = JSON.parse(fixedData);
                        
                        testResults += `âœ… JSON è§£ææˆåŠŸ\n`;
                        testResults += `æ•¸æ“šé …ç›®æ•¸ï¼š${jsonData.length}\n\n`;
                        
                        if (jsonData.length > 0) {
                            const firstItem = jsonData[0];
                            testResults += `ç¬¬ä¸€å€‹é …ç›®çš„æ¬„ä½ï¼š\n`;
                            Object.keys(firstItem).forEach(key => {
                                const value = firstItem[key];
                                testResults += `- ${key}ï¼š${value.length > 20 ? value.substring(0, 20) + '...' : value}\n`;
                            });
                        }
                        
                        testResults += `\nâœ… ç·¨ç¢¼ä¿®å¾©æ¸¬è©¦å®Œæˆï¼æ•¸æ“šå¯ä»¥æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡å…§å®¹ã€‚`;
                        
                    } catch (jsonError) {
                        testResults += `âŒ JSON è§£æå¤±æ•—ï¼š${jsonError.message}\n`;
                        testResults += `æ•¸æ“šæ¨£æœ¬ï¼š${decodedData.substring(0, 100)}...\n`;
                    }
                    
                } catch (decodeError) {
                    testResults += `âŒ è§£ç¢¼å¤±æ•—ï¼š${decodeError.message}`;
                }
                
                alert(testResults);
                console.log('ç·¨ç¢¼æ¸¬è©¦çµæœ:', testResults);
                
            } catch (error) {
                alert('âŒ ç·¨ç¢¼æ¸¬è©¦å¤±æ•—ï¼š' + error.message);
                console.error('ç·¨ç¢¼æ¸¬è©¦éŒ¯èª¤:', error);
            }
        }

        // é¡¯ç¤ºæ­·å²çµ±è¨ˆ
        function showHistoryStats() {
            console.log('=== é¡¯ç¤ºå­¸ç¿’æ­·å²çµ±è¨ˆ ===');
            
            // ç«‹å³é¡¯ç¤ºæç¤ºï¼Œè®“ç”¨æˆ¶çŸ¥é“æŒ‰éˆ•æœ‰åæ‡‰
            console.log('æŒ‰éˆ•è¢«é»æ“Šäº†ï¼Œæ­£åœ¨åŠ è¼‰æ­·å²çµ±è¨ˆ...');
            
            const stats = getStudyStats();
            console.log('å­¸ç¿’çµ±è¨ˆæ•¸æ“š:', stats);
            
            const content = document.getElementById('historyStatsContent');
            const historySection = document.getElementById('historyStatsSection');
            const mainContent = document.querySelector('.main-content');
            
            console.log('çµ±è¨ˆå…§å®¹å®¹å™¨:', content);
            console.log('æ­·å²çµ±è¨ˆå€åŸŸ:', historySection);
            console.log('ä¸»å…§å®¹å€åŸŸ:', mainContent);
            
            if (!content) {
                console.error('æ‰¾ä¸åˆ° historyStatsContent å…ƒç´ ');
                alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°çµ±è¨ˆå…§å®¹å®¹å™¨');
                return;
            }
            
            if (!historySection) {
                console.error('æ‰¾ä¸åˆ° historyStatsSection å…ƒç´ ');
                alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ­·å²çµ±è¨ˆå€åŸŸ');
                return;
            }
            
            if (!stats || Object.keys(stats).length === 0) {
                console.log('æ²’æœ‰å­¸ç¿’æ­·å²è¨˜éŒ„ï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯');
                content.innerHTML = `
                    <div class="no-stats-message">
                        <h3>ğŸ” å°šç„¡å­¸ç¿’æ­·å²ç´€éŒ„</h3>
                        <p>è¦é–‹å§‹è¨˜éŒ„å­¸ç¿’çµ±è¨ˆï¼Œè«‹é€²è¡Œæ¸¬é©—ä¾†ç´¯ç©å­¸ç¿’è¨˜éŒ„</p>
                        <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <p><strong>ğŸ“Š å­¸ç¿’çµ±è¨ˆåŠŸèƒ½ï¼š</strong></p>
                            <ul style="text-align: left; margin: 10px 0;">
                                <li>è‡ªå‹•è¨˜éŒ„æ¯å€‹ç—…å+è­‰å‹çµ„åˆçš„ç­”é¡Œæƒ…æ³</li>
                                <li>è¿½è¹¤ç­”é¡Œæ¬¡æ•¸å’Œæ­£ç¢ºç‡</li>
                                <li>é¡¯ç¤ºå­¸ç¿’é€²åº¦å’Œè–„å¼±ç’°ç¯€</li>
                            </ul>
                        </div>
                        <p><small>é–‹å§‹æ¸¬é©—å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•è¨˜éŒ„æ‚¨çš„å­¸ç¿’çµ±è¨ˆ</small></p>
                    </div>
                `;
            } else {
                console.log(`ğŸ“Š æ‰¾åˆ° ${Object.keys(stats).length} å€‹çµ±è¨ˆé …ç›®`);
                console.log('æ‰€æœ‰çµ±è¨ˆé …ç›®:', Object.keys(stats));
                
                // æŒ‰æ­£ç¢ºç‡æ’åº
                const sortedEntries = Object.entries(stats).sort((a, b) => {
                    const accuracyA = (a[1].correctAttempts / a[1].totalAttempts) || 0;
                    const accuracyB = (b[1].correctAttempts / b[1].totalAttempts) || 0;
                    return accuracyB - accuracyA;
                });

                console.log(`æ’åºå¾Œæº–å‚™é¡¯ç¤º ${sortedEntries.length} å€‹é …ç›®`);

                let tableHTML = `
                    <div style="margin-bottom: 15px; color: rgba(255,255,255,0.8);">
                        <small>ğŸ“ˆ çµ±è¨ˆé …ç›®ç¸½æ•¸: ${sortedEntries.length} å€‹ | æ•¸æ“šæ›´æ–°æ™‚é–“: ${new Date().toLocaleString('zh-TW')}</small>
                    </div>
                    <table class="history-stats-table">
                        <thead>
                            <tr>
                                <th>ç—…å</th>
                                <th>è­‰å‹</th>
                                <th>ç­”é¡Œæ¬¡æ•¸</th>
                                <th>ç­”å°æ¬¡æ•¸</th>
                                <th>æ­£ç¢ºç‡</th>
                                <th>æœ€å¾Œç·´ç¿’æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                sortedEntries.forEach(([key, stat]) => {
                    const accuracy = ((stat.correctAttempts / stat.totalAttempts) * 100).toFixed(1);
                    const lastAttempt = stat.lastAttempt ? 
                        new Date(stat.lastAttempt).toLocaleString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'æœªçŸ¥';
                    
                    tableHTML += `
                        <tr>
                            <td>${stat.diseaseName}</td>
                            <td>${stat.syndromeType}</td>
                            <td>${stat.totalAttempts}</td>
                            <td>${stat.correctAttempts}</td>
                            <td>
                                <div class="accuracy-bar">
                                    <div class="accuracy-fill" style="width: ${accuracy}%"></div>
                                    <div class="accuracy-text">${accuracy}%</div>
                                </div>
                            </td>
                            <td>${lastAttempt}</td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                content.innerHTML = tableHTML;
            }
            
            // éš±è—éŠæˆ²å€åŸŸï¼Œé¡¯ç¤ºæ­·å²çµ±è¨ˆ
            console.log('æº–å‚™åˆ‡æ›é¡¯ç¤ºå€åŸŸ...');
            
            if (mainContent) {
                mainContent.style.display = 'none';
                console.log('å·²éš±è—ä¸»å…§å®¹å€åŸŸ');
            } else {
                console.error('æ‰¾ä¸åˆ°ä¸»å…§å®¹å€åŸŸ');
            }
            
            if (historySection) {
                historySection.classList.remove('hidden');
                historySection.classList.add('show-history');
                console.log('å·²é¡¯ç¤ºæ­·å²çµ±è¨ˆå€åŸŸ');
                console.log('æ­·å²çµ±è¨ˆå€åŸŸæ¨£å¼:', window.getComputedStyle(historySection).display);
            } else {
                console.error('æ‰¾ä¸åˆ°æ­·å²çµ±è¨ˆå€åŸŸ');
            }
        }

        // æ¸…é™¤æ­·å²çµ±è¨ˆ
        function clearHistoryStats() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç¿’æ­·å²è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                deleteCookie('cmGameStudyStats');
                alert('å­¸ç¿’æ­·å²è¨˜éŒ„å·²æ¸…é™¤');
                showHistoryStats(); // é‡æ–°é¡¯ç¤ºç©ºçš„çµ±è¨ˆ
            }
        }

        // éš±è—æ­·å²çµ±è¨ˆï¼Œè¿”å›éŠæˆ²
        function hideHistoryStats() {
            console.log('éš±è—æ­·å²çµ±è¨ˆï¼Œè¿”å›éŠæˆ²');
            const historyStatsSection = document.getElementById('historyStatsSection');
            const mainContentArea = document.querySelector('.main-content');
            
            if (historyStatsSection) {
                historyStatsSection.classList.remove('show-history');
                historyStatsSection.classList.add('hidden');
            }
            
            if (mainContentArea) {
                mainContentArea.style.display = 'block';
            }
        }

        // åŒ¯å‡ºæ­·å²çµ±è¨ˆ
        function exportHistoryStats() {
            const stats = getStudyStats();
            
            if (!stats || Object.keys(stats).length === 0) {
                alert('æš«ç„¡æ­·å²è¨˜éŒ„å¯åŒ¯å‡º');
                return;
            }

            // æº–å‚™CSVæ ¼å¼çš„æ•¸æ“š
            let csvContent = '\uFEFFç—…å,è­‰å‹,ç­”é¡Œæ¬¡æ•¸,ç­”å°æ¬¡æ•¸,æ­£ç¢ºç‡,é¦–æ¬¡ç·´ç¿’æ™‚é–“,æœ€å¾Œç·´ç¿’æ™‚é–“\n'; // æ·»åŠ BOMä»¥æ”¯æ´ä¸­æ–‡
            
            Object.entries(stats).forEach(([key, stat]) => {
                const accuracy = ((stat.correctAttempts / stat.totalAttempts) * 100).toFixed(1);
                const firstAttempt = stat.firstAttempt ? 
                    new Date(stat.firstAttempt).toLocaleString('zh-TW') : 'æœªçŸ¥';
                const lastAttempt = stat.lastAttempt ? 
                    new Date(stat.lastAttempt).toLocaleString('zh-TW') : 'æœªçŸ¥';
                
                csvContent += `"${stat.diseaseName}","${stat.syndromeType}",${stat.totalAttempts},${stat.correctAttempts},"${accuracy}%","${firstAttempt}","${lastAttempt}"\n`;
            });

            // å‰µå»ºä¸‹è¼‰éˆæ¥
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ä¸­é†«å­¸ç¿’çµ±è¨ˆ_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        // æ¸¬è©¦å‡½æ•¸ï¼šå‰µå»ºæ¨¡æ“¬å­¸ç¿’çµ±è¨ˆæ•¸æ“š
        function createTestStudyStats() {
            const testStats = {
                "æ„Ÿå†’_é¢¨å¯’è­‰": {
                    diseaseName: "æ„Ÿå†’",
                    syndromeType: "é¢¨å¯’è­‰",
                    totalAttempts: 5,
                    correctAttempts: 4,
                    firstAttempt: new Date().toISOString(),
                    lastAttempt: new Date().toISOString()
                },
                "å’³å—½_ç—°ç†±è­‰": {
                    diseaseName: "å’³å—½",
                    syndromeType: "ç—°ç†±è­‰",
                    totalAttempts: 3,
                    correctAttempts: 2,
                    firstAttempt: new Date().toISOString(),
                    lastAttempt: new Date().toISOString()
                }
            };
            
            saveStudyStats(testStats);
            console.log('å·²å‰µå»ºæ¸¬è©¦çµ±è¨ˆæ•¸æ“š:', testStats);
            alert('å·²å‰µå»ºæ¸¬è©¦å­¸ç¿’çµ±è¨ˆæ•¸æ“šï¼Œç¾åœ¨å¯ä»¥æ¸¬è©¦æ­·å²åŠŸèƒ½äº†ï¼');
        }

        // æ¸¬è©¦CookieåŠŸèƒ½
        function testCookieFunction() {
            console.log('=== æ¸¬è©¦CookieåŠŸèƒ½ ===');
            
            // æª¢æŸ¥ç•¶å‰å”è­°
            console.log('ç•¶å‰å”è­°:', window.location.protocol);
            console.log('ç•¶å‰ä¸»æ©Ÿ:', window.location.host);
            
            if (window.location.protocol === 'file:') {
                alert('âš ï¸ è­¦å‘Šï¼šæ‚¨æ­£åœ¨ä½¿ç”¨ file:// å”è­°è¨ªå•ç¶²é ã€‚\n\nCookieåŠŸèƒ½å¯èƒ½ç„¡æ³•æ­£å¸¸å·¥ä½œï¼Œå­¸ç¿’çµ±è¨ˆå¯èƒ½ä¸æœƒè¢«ä¿å­˜ã€‚\n\nå»ºè­°ï¼š\n1. ä½¿ç”¨ Python æœå‹™å™¨å•Ÿå‹• (python server.py)\n2. æˆ–ä½¿ç”¨ Live Server ç­‰å·¥å…·');
                return false;
            }
            
            // æ¸¬è©¦è¨­ç½®å’Œè®€å–Cookie
            const testData = { test: 'æ¸¬è©¦æ•¸æ“š', timestamp: new Date().toISOString() };
            setCookie('testCookie', testData);
            
            const retrievedData = getCookie('testCookie');
            
            if (retrievedData && retrievedData.test === 'æ¸¬è©¦æ•¸æ“š') {
                alert('âœ… CookieåŠŸèƒ½æ­£å¸¸ï¼å­¸ç¿’çµ±è¨ˆæ‡‰è©²å¯ä»¥æ­£å¸¸ä¿å­˜ã€‚');
                deleteCookie('testCookie'); // æ¸…é™¤æ¸¬è©¦Cookie
                return true;
            } else {
                alert('âŒ CookieåŠŸèƒ½ç•°å¸¸ï¼å­¸ç¿’çµ±è¨ˆå¯èƒ½ç„¡æ³•ä¿å­˜ã€‚\n\nè«‹æª¢æŸ¥ç€è¦½å™¨è¨­ç½®æˆ–ä½¿ç”¨HTTPæœå‹™å™¨ã€‚');
                return false;
            }
        }

        // èª¿è©¦å‡½æ•¸ï¼šæª¢æŸ¥çµ±è¨ˆæ•¸æ“šç‹€æ…‹
        function debugStats() {
            console.log('=== çµ±è¨ˆæ•¸æ“šèª¿è©¦ä¿¡æ¯ ===');
            const stats = getStudyStats();
            console.log('çµ±è¨ˆæ•¸æ“š:', stats);
            console.log('é …ç›®ç¸½æ•¸:', Object.keys(stats).length);
            
            if (Object.keys(stats).length > 0) {
                console.log('æ‰€æœ‰é …ç›®éµå€¼:', Object.keys(stats));
                
                // é¡¯ç¤ºæ¯å€‹é …ç›®çš„è©³ç´°ä¿¡æ¯
                Object.entries(stats).forEach(([key, stat], index) => {
                    console.log(`é …ç›® ${index + 1}: ${key}`, stat);
                });
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡é …ç›®
                const keys = Object.keys(stats);
                const uniqueKeys = [...new Set(keys)];
                if (keys.length !== uniqueKeys.length) {
                    console.warn('âš ï¸ ç™¼ç¾é‡è¤‡çš„çµ±è¨ˆé …ç›®');
                }
                
                // æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§
                const invalidItems = Object.entries(stats).filter(([key, stat]) => {
                    return !stat.diseaseName || !stat.syndromeType || 
                           typeof stat.totalAttempts !== 'number' || 
                           typeof stat.correctAttempts !== 'number';
                });
                
                if (invalidItems.length > 0) {
                    console.warn('âš ï¸ ç™¼ç¾ç„¡æ•ˆçš„çµ±è¨ˆé …ç›®:', invalidItems);
                }
            }
            
            // æª¢æŸ¥Cookieå¤§å°
            const cookieString = document.cookie;
            console.log('ç•¶å‰æ‰€æœ‰Cookie:', cookieString);
            console.log('Cookieç¸½å¤§å°:', cookieString.length, 'å­—ç¬¦');
            
            // æª¢æŸ¥çµ±è¨ˆCookieçš„å¤§å°
            const statsString = JSON.stringify(stats);
            console.log('çµ±è¨ˆæ•¸æ“šJSONå¤§å°:', statsString.length, 'å­—ç¬¦');
            
            return stats;
        }

        // èª¿è©¦å‡½æ•¸ï¼šæ¸…é™¤æ‰€æœ‰çµ±è¨ˆæ•¸æ“š
        function clearAllStats() {
            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç¿’çµ±è¨ˆæ•¸æ“šå—ï¼Ÿ\n\né€™å°‡æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                removeLocalStorage('cmGameStudyStats');
                console.log('âœ… æ‰€æœ‰çµ±è¨ˆæ•¸æ“šå·²æ¸…é™¤');
                alert('âœ… æ‰€æœ‰çµ±è¨ˆæ•¸æ“šå·²æ¸…é™¤ï¼Œå¯ä»¥é‡æ–°é–‹å§‹è¨˜éŒ„ã€‚');
                
                // é©—è­‰æ¸…é™¤çµæœ
                const remainingStats = getStudyStats();
                console.log('æ¸…é™¤å¾Œå‰©é¤˜æ•¸æ“š:', remainingStats);
                console.log('å‰©é¤˜é …ç›®æ•¸:', Object.keys(remainingStats).length);
            }
        }
        
        // æ¸¬è©¦æ‰¹é‡çµ±è¨ˆæ›´æ–°
        function testBatchStats() {
            console.log('=== é–‹å§‹æ‰¹é‡çµ±è¨ˆæ¸¬è©¦ ===');
            const testCombinations = [
                ['æ„Ÿå†’', 'é¢¨å¯’æŸè¡¨è­‰'],
                ['å’³å—½', 'é¢¨å¯’è¥²è‚ºè­‰'],
                ['å“®è­‰', 'å†·å“®è­‰'],
                ['å–˜è­‰', 'è‚ºè…æ°£è™›è­‰'],
                ['è‚ºè„¹', 'ç—°æ¿å£…è‚ºè­‰'],
                ['è‚ºç—¿', 'è‚ºé™°è™›è­‰'],
                ['è‚ºç™°', 'ç†±æ¯’å£…è‚ºè­‰']
            ];
            
            console.log(`æº–å‚™æ¸¬è©¦ ${testCombinations.length} å€‹ç—…åè­‰å‹çµ„åˆ`);
            
            testCombinations.forEach(([disease, syndrome], index) => {
                console.log(`\n--- æ¸¬è©¦ ${index + 1}/${testCombinations.length}: ${disease}_${syndrome} ---`);
                updateStudyStats(disease, syndrome, Math.random() > 0.5);
            });
            
            console.log('\n=== æ‰¹é‡æ¸¬è©¦å®Œæˆ ===');
            const finalStats = getStudyStats();
            console.log(`æœ€çµ‚çµ±è¨ˆé …ç›®æ•¸: ${Object.keys(finalStats).length}`);
        }
        
        // æ¸¬è©¦åŸºæœ¬LocalStorageåŠŸèƒ½
        function testBasicLocalStorage() {
            console.log('=== æ¸¬è©¦åŸºæœ¬LocalStorageåŠŸèƒ½ ===');
            
            // æ¸¬è©¦1: è¨­ç½®ç°¡å–®çš„æ•¸æ“š
            const testData = { test: 'hello', count: 1 };
            console.log('æ¸¬è©¦1: è¨­ç½®ç°¡å–®LocalStorage');
            setLocalStorage('testStorage', testData);
            
            setTimeout(() => {
                const retrieved = getLocalStorage('testStorage');
                console.log('æª¢ç´¢çµæœ:', retrieved);
                
                // æ¸¬è©¦2: è¨­ç½®è¼ƒå¤§çš„æ•¸æ“š
                const largeData = {};
                for (let i = 0; i < 50; i++) {
                    largeData[`item_${i}`] = {
                        name: `æ¸¬è©¦é …ç›®${i}`,
                        description: `é€™æ˜¯ä¸€å€‹æ¸¬è©¦é …ç›®ï¼ŒåŒ…å«è¼ƒé•·çš„æè¿°æ–‡å­—ï¼Œç”¨ä¾†æ¸¬è©¦LocalStorageçš„å®¹é‡å’Œæ€§èƒ½ã€‚é …ç›®ç·¨è™Ÿ: ${i}`,
                        value: Math.random(),
                        timestamp: new Date().toISOString(),
                        metadata: {
                            created: new Date().toISOString(),
                            version: '1.0',
                            tags: ['test', 'demo', `item${i}`]
                        }
                    };
                }
                
                console.log('æ¸¬è©¦2: è¨­ç½®è¼ƒå¤§LocalStorageæ•¸æ“š');
                setLocalStorage('largeStorage', largeData);
                
                setTimeout(() => {
                    const largeRetrieved = getLocalStorage('largeStorage');
                    console.log('å¤§æ•¸æ“šæª¢ç´¢çµæœé …ç›®æ•¸:', Object.keys(largeRetrieved || {}).length);
                    
                    // æ¸¬è©¦3: æ¸…ç†æ¸¬è©¦æ•¸æ“š
                    removeLocalStorage('testStorage');
                    removeLocalStorage('largeStorage');
                    console.log('æ¸¬è©¦æ•¸æ“šå·²æ¸…ç†');
                }, 100);
                
            }, 100);
        }
        
        // æª¢æŸ¥LocalStorageä½¿ç”¨æƒ…æ³
        function checkStorageUsage() {
            console.log('=== LocalStorage ä½¿ç”¨æƒ…æ³ ===');
            
            try {
                // è¨ˆç®—ç•¶å‰ä½¿ç”¨çš„ç©ºé–“
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        const value = localStorage.getItem(key);
                        totalSize += key.length + (value ? value.length : 0);
                    }
                }
                
                console.log(`ç¸½ä½¿ç”¨ç©ºé–“: ${totalSize} å­—ç¬¦ (${(totalSize / 1024).toFixed(2)} KB)`);
                console.log(`é …ç›®æ•¸é‡: ${localStorage.length}`);
                
                // é¡¯ç¤ºå„å€‹é …ç›®çš„å¤§å°
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        const value = localStorage.getItem(key);
                        const size = key.length + (value ? value.length : 0);
                        console.log(`- ${key}: ${size} å­—ç¬¦ (${(size / 1024).toFixed(2)} KB)`);
                    }
                }
                
                // æª¢æŸ¥çµ±è¨ˆæ•¸æ“š
                const stats = getStudyStats();
                const statsCount = Object.keys(stats).length;
                console.log(`\nå­¸ç¿’çµ±è¨ˆé …ç›®æ•¸: ${statsCount}`);
                
            } catch (error) {
                console.error('æª¢æŸ¥å­˜å„²ä½¿ç”¨æƒ…æ³å¤±æ•—:', error);
            }
        }
    </script>
</body>
</html>